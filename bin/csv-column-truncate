#!/usr/local/bin/php
<?php

use Sebihojda\Mbp\Command\CommandProcessorLocator;
use Sebihojda\Mbp\IO\CsvReader;
use Sebihojda\Mbp\IO\CsvWriter;
use Sebihojda\Mbp\IO\JsonWriter;
use Sebihojda\Mbp\Command\ArgumentConverter\CsvColumnTruncateArgumentConverter;
use Sebihojda\Mbp\TableProcessor\Config\ColumnTruncateConfig;

require_once __DIR__ . '/../vendor/autoload.php';

// get the name of the currently executed tool
$tool = basename($argv[0]);

try {
    // initialize the CLI options parsing
    CsvColumnTruncateArgumentConverter::initOptions();

    // read from input streams into data tables
    $inputTables = [];
    foreach (CsvColumnTruncateArgumentConverter::getInputStreams() as $inputStream) {
        $inputTables[] = CsvReader::read($inputStream, false);
    }

    // execute the prepended header logic on all input tables
    $processor = new CommandProcessorLocator()->getProcessorByTool($tool);
    $config = CsvColumnTruncateArgumentConverter::extractTableProcessorConfig();
    $outputTables = $processor->configure($config)->process(...$inputTables);

    // write the resulted outputTables to output streams
    $outputStream = CsvColumnTruncateArgumentConverter::getOutputStreams()[0];
    foreach ($outputTables as $outputTable) {
        if ($config->getOutputFormat() === ColumnTruncateConfig::OUTPUT_FORMAT_CSV) {
            CsvWriter::write($outputTable, $outputStream);
        } elseif ($config->getOutputFormat() === ColumnTruncateConfig::OUTPUT_FORMAT_JSON) {
            JsonWriter::write($outputTable, $outputStream);
        }
    }
} catch (Throwable $e) {
    echo $e->getMessage().PHP_EOL;
    exit(1);
}
